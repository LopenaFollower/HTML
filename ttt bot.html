<!DOCTYPE html>
<html>
	<head>
		<title>tic tac toe</title>
		<meta name="viewport"content="width=device-width,initial-scale=1">
		<style>
			body{
				color:#fff;
			}
			input{
				color:#000;
			}
			td,table{
				width:130px;
				height:130px;
				text-align:center;
				font-size:104px;
				table-layout:fixed;
				border:2.5px solid #444;
			}
		</style>
	</head>
	<body bgcolor=#222>
		<select id=difficulty oninput="reset();score={X:0,O:0}"><option value=0>Impossible</option><option value=1>Medium</option><option value=2>Easy</option></select>
		<table>
			<tr>
				<td id="1,1"onclick="check(this.id)"></td>
				<td id="1,2"onclick="check(this.id)"></td>
				<td id="1,3"onclick="check(this.id)"></td>
			</tr>
			<tr>
				<td id="2,1"onclick="check(this.id)"></td>
				<td id="2,2"onclick="check(this.id)"></td>
				<td id="2,3"onclick="check(this.id)"></td>
			</tr>
			<tr>
				<td id="3,1"onclick="check(this.id)"></td>
				<td id="3,2"onclick="check(this.id)"></td>
				<td id="3,3"onclick="check(this.id)"></td>
			</tr>
		</table>
		You are <select id=first oninput="reset();score={X:0,O:0}"><option value=0>X</option><option value=1>O</option></select><br>
		<input type=button onclick="reset()"value="reset"/><br><br>
		<div id=win></div>
		<script>
const $=id=>document.getElementById(id),log=console.log,grid_ids=[],
	corners=["1,1","1,3","3,1","3,3"],
	sides=["1,2","2,1","2,3","3,2"],
	winningPatterns=[["1,1","2,1","3,1"],["1,2","2,2","3,2"],["1,3","2,3","3,3"],["1,1","1,2","1,3"],["2,1","2,2","2,3"],["3,1","3,2","3,3"],["1,1","2,2","3,3"],["1,3","2,2","3,1"]];
var me;
var bot;
var lastMove;
var moveCnt=0;
var mode=0;
var canMove=true;
var ongoing=true;
var grid=[];
var score={X:0,O:0};
for(let x=1;x<4;x++)for(let y=1;4>y;y++)grid_ids.push(x+","+y);
Element.prototype.text=function(t=1){
	return t!=1?(this.innerText=t):this.innerText;
}
Array.prototype.rand=function(){
	return this[Math.random()*this.length|0]
}
const t=id=>$(id).text();
function arent(a,...b){
	return a!==b[0]&&b.every(e=>e==b[0])
}
function place(id,s){
	return id&&!win.text("")&&$(id).text()==""&&(grid.push(id))&&$(id).text(s)
}
function check(id){
	canMove&&ongoing&&place(id,me)&&(setTimeout(botMove,150),lastMove=id,canMove=![],moveCnt++);
}
function blockThreat(){
	if(mode==2)return![];
	let toBlock=[];
	let hwm=![];
	for(let i=0;3>i;i++)
		winningPatterns.forEach(e=>{
			let e2=[...e]
			e2.splice(i,1)
			arent("",t(e2[0]),t(e2[1]),bot)&&t(e[i])==""&&(hwm=e[i]);
			arent("",t(e2[0]),t(e2[1]),me)&&t(e[i])==""&&toBlock.push(e[i]);
		})
	let final=toBlock.filter((e,i)=>toBlock.indexOf(e)==i)||[];
	mode&&(final=final[0])
	return hwm||final?.length>0&&final||![]
}
function createThreat(){
	if(mode==2)return![];
	let threats=[];
	grid_ids.forEach(e=>{
		if(t(e)==bot){
			let x=parseInt(e.split(",")[0]);
			let y=parseInt(e.split(",")[1]);
			for(let i=-2;i<3;i+=4)
				for(let o=-1;o<2;o+=2){
					grid_ids.includes(`${x},${y+i}`)&&grid_ids.includes(`${x},${y+i-o}`)&&!$(`${x},${y+i}`).text()&&!$(`${x},${y+i-o}`).text()&&threats.push(`${x},${y+i}`)
					grid_ids.includes(`${x+i},${y}`)&&grid_ids.includes(`${x+i-o},${y}`)&&!$(`${x+i},${y}`).text()&&!$(`${x+i-o},${y}`).text()&&threats.push(`${x+i},${y}`)
				}
		}
	})
	let final=threats.filter((e,i)=>threats.indexOf(e)==i)
	return final.length>0&&final.rand()||![]
}
function beside(p){
	let x=parseInt(p.split(",")[0]);
	let y=parseInt(p.split(",")[1]);
	let points=[];
	for(let i=-1;i<2;i+=2){
		grid_ids.includes(`${x},${y+i}`)&&!$(`${x},${y+i}`).text()&&points.push(`${x},${y+i}`)
		grid_ids.includes(`${x+i},${y}`)&&!$(`${x+i},${y}`).text()&&points.push(`${x+i},${y}`)
	}
	let final=points.filter(e=>{
		let x=parseInt(e.split(",")[0]);
		let y=parseInt(e.split(",")[1]);
		for(let i=-2;i<3;i+=4){
			return grid_ids.includes(`${x},${y+i}`)&&!$(`${x},${y+i}`).text()||grid_ids.includes(`${x+i},${y}`)&&!$(`${x+i},${y}`).text()
		}
	})
	return final.length>0&&final[0]||points.length>0&&points[0]||![]
}
function randomMove(){
	let sp;
	grid_ids.forEach(e=>!$(e).text()&&(sp=e))
	return sp
}
function botMove(){
	if(grid.length==9||!ongoing)return;
	if(bot=="X"&&moveCnt<2){
		if(!mode){
			moveCnt?place(beside(lastMove),bot):place("2,2",bot);
		}else if(mode==1){
			place(sides.rand(),bot);
		}else{
			let r=![]
			while(!r)
				r=place([corners.rand(),sides.rand()].rand(),bot);
		}
	}else if(bot=="O"&&moveCnt==1){
		if(!mode){
			place("2,2",bot)||place(corners.rand(),bot);
		}else{
			let r=![];
			while(!r){
				r=place(mode==1?sides.rand():[corners.rand(),sides.rand()].rand(),bot);
			}
		}
	}else{
		let w=blockThreat()||
			createThreat()||
			beside(lastMove)||
			randomMove();
			place(w,bot);
	}
	setTimeout(()=>canMove=true,100);
}
function winner(w){
	ongoing&&score[w]++&&grid.length<9&&setTimeout(reset,750)
	ongoing=![];
	canMove=![];
	win.text(w+" wins!\nScore: "+score[me]+" - "+score[bot]);
}
function won(){
	winningPatterns.forEach(e=>arent("",t(e[0]),t(e[1]),t(e[2]))&&winner(t(e[0])))
}
function reset(){
	grid_ids.forEach(e=>$(e).text(""));
	lastMove=null;
	grid=[];
	moveCnt=0;
	ongoing=true;
	canMove=![];
	setTimeout(()=>{
		canMove=me=="X";
		!canMove&&botMove();
	},500)
}
setInterval(()=>{
	let fm=first.value;
	me=fm=="1"?"O":"X";
	bot=fm=="0"?"O":"X";
	mode=parseInt(difficulty.value)
	won();
	grid.length==9&&(grid=[])&&setTimeout(reset,500)
})
		</script>
	</body>
</html>