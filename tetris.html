<!DOCTYPE html>
<html>
	<head>
		<title>tetris</title>
		<style>
			*{
				margin:0;
				user-select:none;
				overflow:hidden;
			}
			body{
				background:#333;
			}
			canvas{
				background:#000;
			}
			td{
				width:60px;
				height:60px;
				font-size:60px;
				line-height:0;
				border:thick solid #000;
				border-radius:10px;
				text-align:center;
				color:#fff;
			}
			h1,#score{
				color:#fff;
			}
			#cont{
				top:0;
				position:fixed;
				font-size:50px;
			}
		</style>
	</head>
	<body>
		<canvas id=game></canvas>
		<div id=cont>
			<span id=ne></span><br>
			<input placeholder=seed style="width:40px"id=s oninput="a[0]=5">
		</div>
		<center>
			<h1>Score: <span id=score></span></h1>
			<table>
				<tr>
					<td id=left>←</td>
					<td id=drop>↓</td>
					<td id=right>→</td>
					<td id=rotate>↻</td>
				</tr>
			</table>
		</center>
		<script>
const a=(function(s=function(){
		CANVAS_SIZE=28;
		COLOR_CHANGING=false;return[CANVAS_SIZE,COLOR_CHANGING];
	}(),g=document.getElementById("game")){g.width=s[0]*10;g.height=s[0]*20;document.getElementById("cont").style.left=s[0]*10+5+"px";document.getElementById("s").value=Math.round(Math.random()*10000);return[5,[],s[1]];})(),rgb={step:1,r:255,g:0,b:0,rg:false,gg:true,bg:false,rl:false,gl:false,bl:false,fetch:function(f){if(!f)return"rgb("+this.r+","+this.g+","+this.b+")";if(f.length==3){return"rgb("+this[f[0]]+","+this[f[1]]+","+this[f[2]]+")"}}}
!(function(floor,rand,ceil,canvas,tsq,grid,colors,count,rAF,mpl,gameOver,$,score,ccccc){
	Array.prototype.random=function(){return this[floor(rand($("s").value.length>0?$("s").value:2959201)*this.length)]}
	let ctx=canvas.getContext("2d"),csz=canvas.width/10;
	for(let h=-2;h<20;h++){grid[h]=[];for(let w=0;w<10;w++){grid[h][w]=0;}}
	if(!localStorage.getItem("hs"))localStorage.setItem("hs",0);
	tsq.push(["I","J","L","O","S","T","Z"].random())
	function next(){
		tsq.push(["I","J","L","O","S","T","Z"].random())
		let n=tsq.shift().toUpperCase();
		return{name:n,rot:mpl[n],row:name==="I"?-1:-2,col:grid[0].length/2-ceil(mpl[n][0].length/2)}
	}
	let ttr=next();
	function valid(rot,cr,cc){
		for(let x=0;x<rot.length;x++){
			for(let y=0;y<rot[x].length;y++){
				if(rot[x][y]&&(cc+y<0||cc+y>=grid[0].length||cr+x>=grid.length||grid[cr+x][cc+y])){
					return![];
				}
			}
		}
		return!![];
	}
	function place(){
		for(let r=0;r<ttr.rot.length;r++){
			for(let c=0;c<ttr.rot[r].length;c++){
				if(ttr.rot[r][c]){
					if(ttr.row+r<0){
						score=0;
						for(let o=grid.length-1;o>=0;o--){
							for(let v=o;v>=0;v--){
								for(let n=0;n<grid[v].length;n++){
									grid[v][n]="";
								}
							}
						}
						return;
					}
					grid[ttr.row+r][ttr.col+c]=ttr.name;
				}
			}
		}
		for(let r=grid.length-1;r>=0;){
			if(grid[r].every(c=>!!c)){
				score+=500
				for(let v=r;v>=0;v--){
					for(let c=0;c<grid[v].length;c++){
						grid[v][c]=grid[v-1][c];
					}
				}
			}else r--;
		}
		score+=50
		ttr=next();
	}
	function loop(){
		console.log(ccccc)
		rAF=requestAnimationFrame(loop);
		ctx.clearRect(0,0,csz*10,csz*20);
		for(let r=0;r<20;r++){
			for(let c=0;c<10;c++){
				if(grid[r][c]){
					ctx.fillStyle=colors[grid[r][c]];
					ctx.fillRect(c*csz,r*csz,csz-1,csz-1);
				}
			}
		}
		if(ttr){
			$("ne").innerText=tsq
			$("ne").style.color=colors[tsq]
			if(count++>40){
				ttr.row++;
				count=0;
				if(!valid(ttr.rot,ttr.row,ttr.col)){
					ttr.row--;
					place();
				}
			}
			ctx.fillStyle=colors[ttr.name];
			for(let r=0;r<ttr.rot.length;r++){
				for(let c=0;c<ttr.rot[r].length;c++){
					if(ttr.rot[r][c]){
						ctx.fillRect((ttr.col+c)*csz,(ttr.row+r)*csz,csz-1,csz-1);
					}
				}
			}
		}
		$("score").innerText=score;
		if(score>localStorage.getItem("hs")){
			localStorage.setItem("hs",score)
		}
		let f=0xff;
		rgb.r>f&&(rgb.rg=false,rgb.r=f)
		rgb.g>f&&(rgb.gg=false,rgb.g=f)
		rgb.b>f&&(rgb.bg=false,rgb.b=f)
		rgb.r<0&&(rgb.rl=false,rgb.r=0)
		rgb.g<0&&(rgb.gl=false,rgb.g=0)
		rgb.b<0&&(rgb.bl=false,rgb.b=0)
		rgb.r==f&&rgb.g==0&&rgb.b==0&&(rgb.gg=true)
		rgb.r==f&&rgb.g==f&&rgb.b==0&&(rgb.rl=true)
		rgb.r==0&&rgb.g==f&&rgb.b==0&&(rgb.bg=true)
		rgb.r==0&&rgb.g==f&&rgb.b==f&&(rgb.gl=true)
		rgb.r==0&&rgb.g==0&&rgb.b==f&&(rgb.rg=true)
		rgb.r==f&&rgb.g==0&&rgb.b==f&&(rgb.bl=true)
		rgb.rg&&(rgb.r+=rgb.step)
		rgb.gg&&(rgb.g+=rgb.step)
		rgb.bg&&(rgb.b+=rgb.step)
		rgb.rl&&(rgb.r-=rgb.step)
		rgb.gl&&(rgb.g-=rgb.step)
		rgb.bl&&(rgb.b-=rgb.step)
		if(ccccc)colors={"I":rgb.fetch("rgb"),"O":rgb.fetch("rbg"),"T":rgb.fetch("grb"),"S":rgb.fetch("gbr"),"Z":rgb.fetch("brg"),"J":rgb.fetch("bgr"),"L":rgb.fetch("brb")};
	}
	function move(d){
		if(valid(ttr.rot,ttr.row,d)){
			ttr.col=d;
		}
	}
	function rrot(r){
		if(valid(r,ttr.row,ttr.col)){
			ttr.rot=r;
		}
	}
	function drop(v){
		if(!valid(ttr.rot,v,ttr.col)){
			ttr.row=v-1;
			place();
			return;
		}
		ttr.row=v;
	}
	function hold(e,f,c,i=null){
		e.addEventListener("touchstart",v=>{
			clearInterval(i);e.style.backgroundColor="#666";
			if(gameOver)return;f();
			i=setInterval(f,c);
		});
		e.addEventListener("touchend",v=>{
			clearInterval(i);e.style.backgroundColor="initial";
			i=null;
		});
	}
	hold($("left"),()=>move(ttr.col-1),75)
	hold($("right"),()=>move(ttr.col+1),75)
	hold($("drop"),()=>drop(ttr.row+1),75)
	hold($("rotate"),()=>rrot(ttr.rot.map((row,i)=>row.map((val,j)=>ttr.rot[ttr.rot.length-1-j][i]))),200)
	document.addEventListener("keydown",e=>{
		if(gameOver)return;
		if(e.which===37||e.which===39){
			move(e.which==37?ttr.col-1:ttr.col+1);
		}
		if(e.which==38){
			rrot(ttr.rot.map((row,i)=>row.map((val,j)=>ttr.rot[ttr.rot.length-1-j][i])));
		}
		if(e.which==40){
			drop(ttr.row+1)
		}
	});
	rAF=requestAnimationFrame(loop);
})(Math.floor,(s,res=0)=>{res=(s*31)*a[0]*(1-a[0]);res=res.toString().replace("-","").replace("e+","").replace(".","");a[0]=parseInt(res);return parseFloat("0."+res);},Math.ceil,document.getElementById("game"),a[1],[],{"I":"#0ff","O":"#ff0","T":"#808","S":"#0f0","Z":"red","J":"#00f","L":"#f70"},0,null,{"I":[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],"J":[[1,0,0],[1,1,1],[0,0,0]],"L":[[0,0,1],[1,1,1],[0,0,0]],"O":[[1,1],[1,1]],"S":[[0,1,1],[1,1,0],[0,0,0]],"Z":[[1,1,0],[0,1,1],[0,0,0]],"T":[[0,1,0],[1,1,1],[0,0,0]]},![],(_)=>document.getElementById(_),0,a[2])
		</script>
	</body>
</html>